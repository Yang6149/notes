# 分布式

## 一、分布式锁

 在单机场景下，可以使用语言的内置锁来实现进程同步。但是在分布式场景下，需要同步的进程可能位于不同的节点上，那么就需要使用分布式锁。 

 阻塞锁通常使用互斥量来实现 ：

* 互斥量为 0 表示有其他进程再使用锁，此时处于锁定状态；
* 互斥量为 1 表示未锁定状态。

1 和 0 可以用一个整型值表示，也可以用某个数据是否存在表示。

### 数据库的唯一索引

获得锁时向表中插入一条记录，释放锁时删除这条记录。唯一索引可以保证该记录只被插入一次，那么就可以用这个记录是否存在来判断是否处于锁定状态。

存在一下几个问题：

* 锁么有失效时间，解锁失败的话其他进程无法再获得该锁；
* 只能是非阻塞锁，插入失败直接就报错了，无法重试；
* 不可重入，已经获得锁的进程也必须诚信获得锁。

### Redis 的 SETNX 指令

使用 SETNX （set if exist）指令插入一个键值对，如果 Key 已经存在，那么会返回 False ，否则插入成功并返回 True。

SETNX 指令和数据库的唯一索引类似，保证了只存在一个 Key 的键值对，那么可以用一个 Key 的键值对是否存在来判断是否存于锁定状态。

EXPIRE 指令可以为一个键值对设置一个过期时间，从而避免了数据库唯一索引实现方式
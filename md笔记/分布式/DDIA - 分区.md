# 分区

> 这里的分区（partition），再MongoDB，Elasticsearch和Solr Cloud 种被称为（shard），在Hbase 中称为区域(Region) ，Bigtable 中则是表块 （table），Cassandra 和 Riak 中是需节点（vnode），Couchbase 中叫做虚桶（vBucket），但是分区（partition）是约定俗成的叫法。

## 一、分区与复制

分区通常与复制结合使用，使得每个分区的副本存储在多个节点上。 这意味着，即使每条记录属于一个分区，它仍然可以存储在多个不同的节点上以获得容错能力。 

一个节点可能存储多个分区。 如果使用主从复制模型，则分区和复制的组合如下图所示。

![1584455137990](C:\Users\hasaki\AppData\Roaming\Typora\typora-user-images\1584455137990.png)

## 二、键值数据的分区

### 1. 根据键的范围分区

一种分区的方法是为每个分区指定一块连续的键范围。如果知道范围之间的边界，则可以轻松确定哪个分区包含某个值。键的范围不一定均匀分布，因为数据也很可能不均匀分布。如`[[1-2],[2-3],[4-8]]`

分区边界可以由管理员手动选择，也可以由数据库自动选择。 Bigtable使用了这种分区策略，以及其开源等价物HBase ，RethinkDB和2.4版本之前的MongoDB 。

在每个分区中，我们可以按照一定的顺序保存键。**好处是进行范围扫描非常简单**,例如以时间戳为主键，可以轻松获取某个月份的所有数据。

然而，Key Range分区的**缺点是某些特定的访问模式会导致热点。**可以转变为时间戳+其他判定词组合作为主键，传入不同的分区。

### 2. 根据键的散列分区

由于偏斜和热点的风险，许多分布式数据存储使用散列函数来确定给定键的分区。

出于分区的目的，散列函数不需要多么强壮的加密算法：例如，Cassandra和MongoDB使用MD5，Voldemort使用Fowler-Noll-Vo函数。

![1584457136808](https://raw.githubusercontent.com/Yang6149/typora-image/master/demo/202003/17/225954-272244.png)

但是这样就缺少了范围分区的范围查询高效能力

### 3. 负载倾斜与消除热点

例如，在社交媒体网站上，一个拥有数百万 follower 的网红用户在做某事时可能会引发一场风暴。

可以通过在主键前加两位十进制的数，把当前主键的数据分散为100个不同的主键。但是需要额外消耗查询时，把100个主键的顺序合并起来。根据具体情况权衡。

## 三、分片与次级索引

如果涉及次级索引，情况会变得更加复杂。辅助索引通常并**不能唯一地标识记录，而是一种搜索记录中出现特定值**的方式：查找用户123的所有操作，查找包含词语 hogwash 的所有文章，查找所有颜色为红色的车辆等等。 

次级索引也是Solr和Elasticsearch等搜索服务器的基石。 

次级索引的问题是它们不能整齐地映射到分区。有两种用二级索引对数据库进行分区的方法：基于文档的分区（**document-based**）和基于关键词（**term-based**）的分区。 

### 按文档的二级索引

假设你正在经营一个销售二手车的网站（如图6-4所示）。 每个列表都有一个唯一的ID——称之为文档ID——并且用文档ID对数据库进行分区（例如，分区0中的ID 0到499，分区1中的ID 500到999等）。 

你想让用户搜索汽车，允许他们通过颜色和厂商过滤，所以需要一个在颜色和厂商上的次级 索引（文档数据库中这些是字段（**field**），关系数据库中这些是列（**column**） ）。 如果您声明了索引，则数据库可以自动执行索引。例如，无论何时将红色汽车添加到数据库，数据库分区都会自动将其添加到索引条目 color：red 的文档ID列表中。 

![1584458742648](https://raw.githubusercontent.com/Yang6149/typora-image/master/demo/202003/17/232631-824038.png)

在这种索引方法中，每个分区是完全独立的：每个分区维护自己的二级索引，仅覆盖该分区 

中的文档。

无论何时您需要写入数据库（添加，删除或更新文档），只需处理包含您正在编写的文档ID的分区即可。出于这个原因，文档分区索引被称为本地索引（**local index**）

### 根据关键词（Term）的二级索引

我们可以构建一个覆盖所有分区数据的全局索引，而不是给每个分区创建自己的次级索引（本地索引）。

但是，我们不能只把这个索引存储在一个节点上，因为它可能会成为瓶颈，违背了分区的目的。全局索引也必须进行分区，但可以采用与主键不同的分区方式。

![1584459086615](https://raw.githubusercontent.com/Yang6149/typora-image/master/demo/202003/17/233127-29187.png)

这里 a-r 为 P1，s-z 为 P2

我们将这种索引称为关键词分区（**term-partitioned**），因为我们寻找的关键词决定了索引的分区方式。

全局索引的优点是：只需要在一个分区里就可以查询所有分区的主键。

缺点：读写速度较慢且复杂，因为单个文档中的写入可能会影响多个分区中的二级索引。

理想情况下：索引总是最新的，写入数据库的每个文档会立刻反应到索引中。但是关键词分区索引中，需要跨分区的分布式事务，并不是所有数据库都支持。**在实践中通常全局的二级索引是异步的。**

## 四、分区再平衡

随着时间的推移，数据库会有各种变化：增加 CPU 处理负载、添加更多磁盘和 RAM 来存储数据集、机器出故障需要其他机器接管。

将负载从集群的一个节点向另一个节点移动的过程称为再平衡（reblancing）。

再平衡通产需要满足一些最低要求：

* 再平衡之后，负载（数据存储，读取和写入请求）应该在集群中的节点之间公平地共享。
* 发生再平衡后，数据库应该继续接收读取和写入。
* 节点之间只移动必须地数据，以便快速再平衡，并减少网络和磁盘 I/O 负载。

### 1. 平衡策略

> 反面教材：hash mod N
>
> 每分配一个新地节点，其他节点都需要移动。平衡消耗太昂贵。

#### 固定数量分区

创建大量分区。比如：10个节点上分配1000个分区。再增加节点地话只需要从每个当前节点拿一些分区进行分配。

![1584496860837](https://raw.githubusercontent.com/Yang6149/typora-image/master/demo/202003/18/100102-183660.png)

这种方法可以在更强大地节点上分配更多地分区，在Riak ，Elasticsearch ，Couchbase 和Voldemort 中使用了这种再平衡的方法。

分区一般是在数据库第一次建立时确定地，但是大小总是难以预料，分区太大，平衡、恢复节点时地开销大，分区小，会产生很多开销。数据量变动很大则很难达到最佳性能。

#### 动态分区

按照键范围进行分区地数据库（Hbase）会动态创建分区。当分区数据超过配置地大小时，会被分成两个分区。相反数据被删除可以合并为同一个分区类似B树地过程。

在最开始空数据库只有一个分区地时候，都是往一个分区里写，可能造成压力过大，所以 HBase、MongoDB 允许在一个空地数据库上配置一组初始分区（预分割）

#### 按节点比例分区

前两种办法分区地数量都与节点数量无关

这种方法就是节点分配固定数量地分区，通过增加或减少节点来。

相当于前两个方法的思想结合，当增加一个新地节点，把之前节点分区拆分后分给新的节点。

> 运维：手动还是自动：
>
> 手动降低不可预测性，自动速度快风险高

## 五、请求路由

现在分区分好了，但是请求的时候要怎么请求呢？比如想要读写键`foo`需要连哪个 IP 和 Port？

这个问题可以概括为 服务发现（service discovery），它不仅限于数据库。可以时任何网络访问的软件的问题。

概括有如下方案：

1. 允许客户联系任何节点。如果该节点恰巧拥有请求的分区，则它可以直接处理该请求；否则转发至适当的节点，接收回复并传递给客户端。
2. 首先将所有来自客户端的请求发送到路由层，它决定了应该处理请求的节点，并相应的转发，路由层仅负责分区的负载均衡。
3. 要求客户端知道分区和节点的分配。在这种情况下，客户端可以直接连接到适当的节点，不需要中介。

![1584502682621](https://raw.githubusercontent.com/Yang6149/typora-image/master/demo/202003/18/113803-264342.png)

如何了解分区-节点之间的分配关系变化？ 

许多分布式数据系统都依赖于一个独立的协调服务，比如 Zookeeper 来跟踪集群元数据，如下图。每个节点在 Zookeeper 中注册自己，ZooKeeper 维护分区到节点的可靠映射。其他参与者（路由器或感知客户端）可以在

 ZooKeeper 中订阅此信息。只要分配发生变化（增删节点），Zookeeper 就会通知路由层使路由信息保持最新状态。

![1584503025515](https://raw.githubusercontent.com/Yang6149/typora-image/master/demo/202003/18/115056-431506.png)

## 六、执行并查询

通常用于分析的大规模并行处理（**MPP, Massively parallel processing**） 关系型数据库产品在其支持的查询类型方面要复杂得多。一个典型的数据仓库查询包含多个连接，过滤，分组和聚合操作。MPP查询优化器将这个复杂的查询分解成许多执行阶段和分区，其中许多可以在数据库集群的不同节点上并行执行。涉及扫描大规模数据集的查询特别受益于这种并行执行。 这些部分在后面笔记讨论。

## 七、总结

这里讨论了将大数据集话分为更小的子集。在单台机器上存储和处理不再可行，则分区十分必要。

分区的目标是在多台机器上均匀分布数据和查询负载，避免出现热点。

分区方法主要为：

* 范围分区
* 散列分区

还讨论了分区和二级索引之间的相互作用。二级索引分区的两种办法：

* 按照文档分区：二级索引和主键和值在相同分区
* 按关键词分区：全局索引，在不同分区

最后还说了查询路由到适当的分区的技术，从简单的分区负载到复杂的并行查询执行引擎。
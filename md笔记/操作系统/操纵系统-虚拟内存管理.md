# 操纵系统-虚拟内存管理

## 一、分页式管理

### 页

物理块来说，页是一个虚拟内存，是逻辑地址空间顺序等分而成的逻辑空间，有连续的编号，大小在 512B-8KB.

### 物理块

物理块就不多bb了，物理块的大小要和页一致。

### 逻辑地址结构

![1585577396216](C:\Users\hasaki\AppData\Roaming\Typora\typora-user-images\1585577396216.png)

### 页表

 页表是需要一直驻留在物理内存中的（多级页表除外），另外页表的起址和长度存放在 PCB（Process Control Block）进程控制结构体中。

正常流程就是，进程访问逻辑地址->找到逻辑地址所在页->通过所在页号在页表里面查找物理块号->访问物理地址。

![1585577609130](https://raw.githubusercontent.com/Yang6149/typora-image/master/demo/202003/30/221329-762500.png)

### 快表（TLB，Translation Look aside Buffer）

快表是为了加快虚拟地址到物理地址转化而存在的。页式存储管理的快表是一般存放在内部的高速缓冲存储器 Cache。一般查询时先在快表上查，查不到就去内存中的页表上查，并将对应的页表放入到快表（CPU缓冲区）中。

### 一级页表

 由于页表必须连续存放，并且需要常驻物理内存，当逻辑地址空间很大时，导致页表占用内存空间很大。

例如，地址长度 32 位，可以得到最大空间为 4GB，页大小 4KB，最多包含 4G/4K=1M 个页。若每个页表项占用 4 个字节，则页表最大长度为 4MB，即要求内存划分出连续 4MB 的空间来装载页表；若地址程度为 64 位时，就需要恐怖的 4*2^52Byte 空间来存储页表了。而且页表采用的是连续分配，不是分页分配。

### 二级页表

![1585578181216](https://raw.githubusercontent.com/Yang6149/typora-image/master/demo/202003/30/222302-751927.png)

等于把n*m的单页大小变成了（n和m）的单页大小。

## 二、段页式管理

### 段

- 段的划分是具有逻辑意义的，例如：主程序段、数据段、堆栈段、子程序段等；
- 每个段都是从 0 开始的独立逻辑地址空间；
- 而且各个段的长度因程序而不同。

### 虚拟地址

[段式](https://www.tomorrow.wiki/archives/tag/%e6%ae%b5%e5%bc%8f)[存储器管理](https://www.tomorrow.wiki/archives/tag/%e5%ad%98%e5%82%a8%e5%99%a8%e7%ae%a1%e7%90%86)将虚拟地址分为两部分：**段号**和**段内地址**。与[页式](https://www.tomorrow.wiki/archives/tag/%e9%a1%b5%e5%bc%8f)中虚拟地址不同的是，段内地址的位数不是固定的，段号与段内地址的划分不是简单地将一个二进制地址进行高低位的切割得到的。

![1585582155499](C:\Users\hasaki\AppData\Roaming\Typora\typora-user-images\1585582155499.png)

![1585582142652](C:\Users\hasaki\AppData\Roaming\Typora\typora-user-images\1585582142652.png)

### 地址转换过程

1. 进程访问某个逻辑地址时，先取得段号
2. 若段号大于段表长度，越界错误
3. 查段表得到段开始地址和段长度
4. 若段内地址大于段长度，越界错误
5. 通过段开始地址和段内地址得到物理地址
6. 根据物理地址读取数据

![1585582302002](https://raw.githubusercontent.com/Yang6149/typora-image/master/demo/202003/30/233142-801907.png)

## 三、分页和分段的区别

- 页是信息的物理单位，满足系统空间管理需要。分页实现离散分配方式，以消减内存的外零头， 提高内存的利用率；
  段是信息的逻辑单位，满足用户需要
- 页的大小固定，由系统决定；
  段的长度不固定， 由用户决定
- 分页的作业地址空间是一维的（虚拟地址由一个数表示）；
  分段的作业地址空间则是二维的（虚拟地址有两个数（段号和段内地址）表示）

### 段页式

段页式存储器管理则是将段式与页式结合，优缺点互补。

- 段面向用户程序需要，段长度不固定；段需要连续分配空间，存在连续分配的缺点，例如易产生碎片；
- 结合段式和页式两者管理优点，既能节省内存空间，提高内存分配效率；又能兼顾用户程序需要。

![1585583091386](https://raw.githubusercontent.com/Yang6149/typora-image/master/demo/202003/30/234451-742966.png)

1. 进程访问某个逻辑地址时，先取得段号
2. 段号大于段表长度，越界错误
3. 查段表，得到页表开始地址
4. 在页表内，根据段内页号查物理块号
5. 页内地址直接对应块内地址
6. 通过物理块号和块内地址得到物理地址
7. 根据物理地址读取数据